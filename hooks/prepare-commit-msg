#!/bin/bash
# AI-powered commit message generator using prepare-commit-msg hook
# åœ¨ git commit æ—¶è‡ªåŠ¨è°ƒç”¨ AI ç”Ÿæˆ commit message
#
# å®‰è£…: å°†æ­¤æ–‡ä»¶æ”¾åˆ° .git/hooks/prepare-commit-msg å¹¶æ·»åŠ æ‰§è¡Œæƒé™
# é…ç½®: export GEMINI_API_KEY='your-key' æˆ– ANTHROPIC_API_KEY æˆ– OPENAI_API_KEY
#
# è·³è¿‡ AI ç”Ÿæˆ: git commit -m "your message" æˆ– GIT_AI_SKIP=1 git commit
# ä¼˜å…ˆçº§: GEMINI > ANTHROPIC > OPENAI

set -e

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
SHA1=$3

# è·³è¿‡æ¡ä»¶ï¼šmergeã€squashã€å·²æœ‰ messageã€ç¯å¢ƒå˜é‡è·³è¿‡
if [ "$COMMIT_SOURCE" = "merge" ] || [ "$COMMIT_SOURCE" = "squash" ]; then
    exit 0
fi

if [ "$COMMIT_SOURCE" = "message" ]; then
    exit 0
fi

if [ -n "$GIT_AI_SKIP" ]; then
    exit 0
fi

# è·å– staged changes
DIFF=$(git diff --cached --no-color 2>/dev/null)

if [ -z "$DIFF" ]; then
    exit 0
fi

# è·å–å˜æ›´ç»Ÿè®¡
STATS=$(git diff --cached --stat 2>/dev/null)
FILES_CHANGED=$(git diff --cached --name-only 2>/dev/null | head -20)

# é™åˆ¶ diff é•¿åº¦ï¼ˆçº¦ 4000 å­—ç¬¦ï¼‰
DIFF_LIMITED=$(echo "$DIFF" | head -c 4000)

# æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯
CONTEXT="Files changed:
$FILES_CHANGED

Stats:
$STATS

Diff (truncated):
$DIFF_LIMITED"

# ç”Ÿæˆå‡½æ•°ï¼šGemini API (Google)
generate_with_gemini() {
    local prompt="You are a git commit message expert. Generate a commit message based on the changes below.

Rules:
1. Use conventional commits: type(scope): description
2. Types: feat, fix, docs, style, refactor, perf, test, chore, build
3. First line under 72 characters
4. Be specific and concise
5. Use Chinese if the code comments are in Chinese, otherwise English
6. Output ONLY the commit message, no quotes, no explanation

Changes:
$CONTEXT"

    local escaped_prompt
    escaped_prompt=$(printf '%s' "$prompt" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

    local response
    response=$(curl -s --max-time 30 \
        "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=$GEMINI_API_KEY" \
        -H "Content-Type: application/json" \
        -d "{
            \"contents\": [{\"parts\": [{\"text\": $escaped_prompt}]}],
            \"generationConfig\": {\"maxOutputTokens\": 200}
        }" 2>/dev/null)

    echo "$response" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    text = data.get('candidates', [{}])[0].get('content', {}).get('parts', [{}])[0].get('text', '')
    # æ¸…ç†å¼•å·å’Œå¤šä½™ç©ºç™½
    text = text.strip().strip('\"').strip(\"'\")
    print(text)
except:
    pass
" 2>/dev/null
}

# ç”Ÿæˆå‡½æ•°ï¼šAnthropic API
generate_with_anthropic() {
    local prompt="You are a git commit message expert. Generate a commit message based on the changes below.

Rules:
1. Use conventional commits: type(scope): description
2. Types: feat, fix, docs, style, refactor, perf, test, chore, build
3. First line under 72 characters
4. Be specific and concise
5. Use Chinese if the code comments are in Chinese, otherwise English
6. Output ONLY the commit message, no quotes, no explanation

Changes:
$CONTEXT"

    local escaped_prompt
    escaped_prompt=$(printf '%s' "$prompt" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

    local response
    response=$(curl -s --max-time 30 https://api.anthropic.com/v1/messages \
        -H "Content-Type: application/json" \
        -H "x-api-key: $ANTHROPIC_API_KEY" \
        -H "anthropic-version: 2023-06-01" \
        -d "{
            \"model\": \"claude-3-5-haiku-20241022\",
            \"max_tokens\": 200,
            \"messages\": [{\"role\": \"user\", \"content\": $escaped_prompt}]
        }" 2>/dev/null)

    echo "$response" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    text = data.get('content', [{}])[0].get('text', '')
    # æ¸…ç†å¼•å·å’Œå¤šä½™ç©ºç™½
    text = text.strip().strip('\"').strip(\"'\")
    print(text)
except:
    pass
" 2>/dev/null
}

# ç”Ÿæˆå‡½æ•°ï¼šOpenAI API
generate_with_openai() {
    local prompt="Generate a git commit message for these changes. Use conventional commits format (type: description). Output ONLY the message.

$CONTEXT"

    local escaped_prompt
    escaped_prompt=$(printf '%s' "$prompt" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

    local response
    response=$(curl -s --max-time 30 https://api.openai.com/v1/chat/completions \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $OPENAI_API_KEY" \
        -d "{
            \"model\": \"gpt-4o-mini\",
            \"max_tokens\": 200,
            \"messages\": [{\"role\": \"user\", \"content\": $escaped_prompt}]
        }" 2>/dev/null)

    echo "$response" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    text = data.get('choices', [{}])[0].get('message', {}).get('content', '')
    text = text.strip().strip('\"').strip(\"'\")
    print(text)
except:
    pass
" 2>/dev/null
}

# å†™å…¥é»˜è®¤å†…å®¹çš„å‡½æ•°
write_fallback() {
    local reason=$1
    cat > "$COMMIT_MSG_FILE" << EOF

# $reason
#
# Changes to be committed:
$(git diff --cached --stat 2>/dev/null | sed 's/^/#   /')
#
# Files:
$(git diff --cached --name-only 2>/dev/null | sed 's/^/#   /')
EOF
}

# ä¸»é€»è¾‘ï¼šæ£€æŸ¥ API Key å¹¶ç”Ÿæˆï¼ˆä¼˜å…ˆçº§: GEMINI > ANTHROPIC > OPENAIï¼‰
MESSAGE=""

if [ -n "$GEMINI_API_KEY" ]; then
    MESSAGE=$(generate_with_gemini)
elif [ -n "$ANTHROPIC_API_KEY" ]; then
    MESSAGE=$(generate_with_anthropic)
elif [ -n "$OPENAI_API_KEY" ]; then
    MESSAGE=$(generate_with_openai)
else
    write_fallback "Set GEMINI_API_KEY, ANTHROPIC_API_KEY, or OPENAI_API_KEY to enable AI commit messages"
    exit 0
fi

# æ£€æŸ¥æ˜¯å¦æˆåŠŸç”Ÿæˆ
if [ -n "$MESSAGE" ] && [ ${#MESSAGE} -gt 5 ]; then
    # è·å–æ–‡ä»¶æ•°å’Œè¡Œæ•°å˜åŒ–
    FILES_COUNT=$(git diff --cached --name-only 2>/dev/null | wc -l | tr -d ' ')
    INSERTIONS=$(git diff --cached --stat 2>/dev/null | tail -1 | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
    DELETIONS=$(git diff --cached --stat 2>/dev/null | tail -1 | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo "0")

    # å†™å…¥ç”Ÿæˆçš„ message å’Œç¡®è®¤æŒ‡å¼•
    cat > "$COMMIT_MSG_FILE" << EOF
$MESSAGE

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ¤– AI-generated commit message
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  âœ… ç¡®è®¤æäº¤: ä¿å­˜å¹¶é€€å‡ºç¼–è¾‘å™¨ (:wq æˆ– :x)                    â”‚
# â”‚  âŒ å–æ¶ˆæäº¤: åˆ é™¤æ‰€æœ‰éæ³¨é‡Šå†…å®¹åä¿å­˜ï¼Œæˆ–ç›´æ¥é€€å‡º (:q!)       â”‚
# â”‚  âœï¸  ä¿®æ”¹ä¿¡æ¯: ç›´æ¥ç¼–è¾‘ä¸Šæ–¹çš„ commit message                  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ğŸ“Š æœ¬æ¬¡å˜æ›´ç»Ÿè®¡:
#    æ–‡ä»¶æ•°: $FILES_COUNT | æ–°å¢: +$INSERTIONS | åˆ é™¤: -$DELETIONS
#
# ğŸ“ å˜æ›´æ–‡ä»¶:
$(git diff --cached --name-only 2>/dev/null | sed 's/^/#   /')
#
# ğŸ“ å˜æ›´è¯¦æƒ…:
$(git diff --cached --stat 2>/dev/null | sed 's/^/#   /')
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
else
    write_fallback "AI generation failed - please write commit message manually"
fi

exit 0
